<!-- Injected site-wide: Game modal and loader -->
<style>
  /* Semi-transparent page overlay behind the game */
  .modal-backdrop.show { background-color: rgba(5,17,28,0.62); }
  /* Remove chrome/background from the wrapper window */
  #gameModal .modal-content { background-color: transparent; box-shadow: none; }
  #gameModal .modal-body { background-color: transparent; }
  /* Subtle styling for overlay buttons without dimming the game */
  #gameModal .btn-light { background-color: rgba(255,255,255,0.88); border-color: rgba(255,255,255,0.88); }
  body.modal-open { overflow: hidden; }
</style>

<div class="modal fade" id="gameModal" tabindex="-1" aria-labelledby="gameModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content" style="border:0; border-radius:0;">
      <div class="modal-body p-0" style="overflow:hidden; position:relative;">
        <!-- Overlay controls (do not consume layout height) -->
        <a id="gameOpenNewTab" class="btn btn-light btn-sm position-absolute top-0 start-0 m-2" href="#" target="_blank" rel="noopener">Open in new tab</a>
        <button type="button" class="btn btn-light btn-sm position-absolute top-0 end-0 m-2" data-bs-dismiss="modal" aria-label="Close">Close</button>
        <iframe id="gameFrame" title="Interactive Scenario" allowfullscreen allow="fullscreen; autoplay; clipboard-read; clipboard-write" style="border:0; width:100%; display:block;"></iframe>
      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    var modalEl = document.getElementById('gameModal');
    var frame = document.getElementById('gameFrame');
    var newTab = document.getElementById('gameOpenNewTab');
    var gameURL = null;

    function setURL(url){
      gameURL = url || '/assets/game/index.html';
      if(newTab) newTab.href = gameURL;
    }

    // Handle clicks on any element with data-game-url
    document.addEventListener('click', function(ev){
      var t = ev.target.closest('[data-game-url]');
      if(!t) return;
      ev.preventDefault();
      setURL(t.getAttribute('data-game-url'));
      try {
        // Prefer Bootstrap modal if available
        var modal = window.bootstrap && window.bootstrap.Modal ? new window.bootstrap.Modal(modalEl) : null;
        if(modal){ modal.show(); } else {
          // Fallback: open in new tab
          window.open(gameURL, '_blank', 'noopener');
          return;
        }
      } catch(e) {
        window.open(gameURL, '_blank', 'noopener');
        return;
      }
    });

    function viewportHeight(){
      // Prefer visualViewport for mobile browsers to get actual visible height
      return (window.visualViewport && window.visualViewport.height) || window.innerHeight || document.documentElement.clientHeight || 600;
    }
    function sizeFrame(){
      if(!modalEl || !frame) return;
      var h = viewportHeight();
      var body = modalEl.querySelector('.modal-body');
      if(body){ body.style.height = h + 'px'; }
      frame.style.height = h + 'px';
    }

    // Lazy-load the iframe once the modal is shown and fit to viewport
    if(modalEl){
      modalEl.addEventListener('shown.bs.modal', function(){
        if(!frame.src){ frame.src = gameURL || '/assets/game/index.html'; }
        sizeFrame();
      });
      modalEl.addEventListener('hidden.bs.modal', function(){
        try { frame.contentWindow && frame.contentWindow.postMessage({type:'pause'}, '*'); } catch(e) {}
      });
      window.addEventListener('resize', sizeFrame);
    }
  })();
</script>
